---
title: "Eastern Bering Sea stock assessment model evaluations"
author:
  - name: James Ianelli
    id: ji
    orcid: 0000-0002-7170-8677
    email: jim.ianelli@noaa.gov
    affiliation: 
      - name: Alaska Fisheries Science Center
        city: Seattle
        state: WA
        url: https://www.fisheries.noaa.gov/alaska/population-assessments/north-pacific-groundfish-stock-assessments-and-fishery-evaluation
format: 
  pdf:
    includes:
      in_header: "doc/preamble.tex"
editor_options: 
  chunk_output_type: console
bibliography: doc/references.bib
---

```{r setup}
#| echo: false
#| warning: false

#source(here::here("R","prelims.R"))
library(ebswp)
load(file="doc/septmod.rdata")
load(file="doc/modtune.rdata")
thisyr=2022
nextyr=thisyr+1
#names(modlst) <-  c("Last year", "Diagonal cov BTS","GenGam","SSB0","SSB1","SSB2","AVO new","AVO full")
mod_names<-names(modlst)
mod_tune_names<-names(modtune)
#\label{tab:modcomp} 
```

# Background

Presently the Eastern Bering Sea pollock assessment has remained essentially the same for a relatively long period with main changes arising from alternative methods for processing the data prior to application within the assessment model. In 2023, there are again some modest changes in how data are processed (specifically the acoustic data from the bottom-trawl survey data, so-called "AVO" has been reanalyzed). In addition, we updated and re-evaluate some of the other input data specifications and also begin to examine some alternative model platforms. As part of this exercise we re-evaluated the relative weights among different data sets used. This included also evaluating alternative process-error specifications (e.g., the amount of allowed variability among processes related to time-varying selectivity). Table 1 below shows the model evaluations examined, the naming convention used, and the relevant comparisons and notes.

```{=tex}
\hypertarget{tbl-plan}{}
\begin{table}[ht]
\centering
\caption{\label{tbl-plan}Model configuration comparisons for the EBS pollock stock assessment.}
\tabularnewline
\scalebox{0.80}{
\begin{tabular}{p{1.5in}p{.5in}p{.75in}p{4.5in}}
\hline
Description                    & Name   & Comparison      & Notes                                                                                                                                                                                                                                       \\
\hline
Base                           & base   &                 & Original from folder 07, now in folder base22 with new code that accommodates FTNIR and GenGamma                                                                                                                                            \\
Base from 2022                 & base22 & base            & As in base but with updated error terms for acoustic-trawl survey biomass estimates                                                                                                                                                         \\
\hline 
AVO new series                 & avon1  & base22          & Newly integrated acoustic backscatter from "Acoustic vessels of opportunity"--namely the bottom-trawl survey vessels. Includes data from 2009 (data from early and in 2011 and 2013 omitted). \\
AVO full                       & avon2  & base22, avon1   & As in avon1 but with data from 2006-2008, 2011, and 2013 used from previous series (rescaled to have the same mean)\\
\hline 
Tuned TV selectivity for ATS   & ProcTune & avon2        & As in avon2 but with time-varying (TV) ATS selectivity variability "tuned"  to achieve model consistency with input variance terms\\
Tuned observation errors for 
indices                        & ObsErr & avon2    & As in avon2 but with input index variability estimated for consistencey with model fit\\
\hline 
Ageing error                   & agerr  & ProcTune        & Include age-determination error matrix \\
Diagonal                       & diag   & ProcTune        & As in base but with updated error terms for acoustic-trawl survey biomass estimates                                                                                                                                                         \\
Generalized Gamma distribution & gengam & diag            & This is based on the MCMC posterior samples generated from the process of accounting for density-dependence within tows; the goal is to evaluate annually varying distribution assumptions compared to the standard lognormal distribution. \\
\hline 
Alternative wt-age for SSB     & ssb0   & base22          & Impact on SSB, consider variability by new wt-age estimates, but start w/ constant mean wt-age                                                                                                                                              \\
                               & ssb1   & base22, ssb     & Use raw means from A-season fishery as a proxy                                                                                                                                                                                              \\
                               & ssb2   & base22, ssb     & Use predictions from random-effects model                                                                                                                                                                                                   \\
\hline 
Base Proposed                  & prop   & avon2         & Full AVO series and with the smoothed mean-wt-age (ssb2))      \\
Base Alternative               & diag2   & prop          & As with "prop" but diagonal matrix to compare with other platforms \\
AMAK platform                  & amak    & diag2         & As with "diag2" data but uses "AMAK2" software configured to be similar to base22 \\
\hline 
\end{tabular}
}
\end{table}
```
These models are contrasted and categorized by the type of analysis involved. Specifically, we start with the 2022 assessment model and data configuration, then apply the revised new AVO series (AVON). We then applied the different tuning approaches.

# Methods

## Revised opportunistic acoustic data series

The new time series of data for the AVO data shows a peak estimate in 2015 and less of an increase in 2019-2022 (@fig-avodata). These new data represent a broader area and are considered an improvement over the previously calibrated grid cells.

## Model tuning: observation versus process-error specifications

Our approach was to attempt to bookend model consistency by either inflating (or reducing) as needed the input specified variances (model right, data conflicts) at one end (e.g., @Francis2011). At the other end, we assume process errors are mis-specified and that the input data variance terms are "correct." The goal is to contrast different statistical properties common in modern stock assessments (i.e., estimating addional variance (Punt??) versus adjusting model flexibility (@stewart2017fra , @Martell2013a). Here we define a model as being "consistent" when the specified (or estimated) observation-error variances are about equal to the residual variances from the model fit.

To achieve consistency using the observation-error estimation approach, we iterated on the magnitude of the mean index coefficient of variation. This approach assumes the process/model specification is appropriate and that the observation errors require tuning. We note that in other settings such "added variance" terms can optionally be freely estimated (e.g., @methot2013) but here it took only four iterations to achieve standard deviations of the normalized residuals equal to 1.0 (@Francis2011).

For the process error term we focussed on the index that appeared to be mis-specified (i.e., the residual variance was greater than the specified input variances). This mean re-evaluating the degree of process error terms for the acoustic-trawl survey selectivity. In the base model, the selectivity was assumed to be constant). Initial trials resulted in this process error to have the ability to achieve estimation consistency (where the variances specified are consistent with the model's fit to the data).

@francis2017fr provides

## Weight-at-age used for spawning biomass

Traditionally, the spawning biomass body weight-at-age used for the pollock assessment was set to be equal to the fishery values which vary over time. This was selected mainly because there are more samples than those available from any survey data and included periods when pollock peak spawning occurs (in early spring / late winter). Additionally, the methods used to estimate near-term weight-at-age considers the recent mean values, the estimation uncertainty of those means (i.e., inverse-variance weighted), and accounts for cohort-effects (e.g., see @ianelli2022).

In Ianelli et al. (2007) a method to include predictions and uncertainty estimates in weight-at-age was developed. Briefly, this involved estimating a vector of parameters ($w_{ta}^{future}$) on current (`r thisyr`) and future mean weights for each age $i$, $i$= (1, 2,...,15), given actual observed mean and variances in weight-at-age over the period 1991-`r thisyr-1`. The values of based on available data and (if this option is selected) estimates the parameters subject to the natural constraint: $$w_{ta}^{future} \sim \mathcal{N}(\bar{w_{a}},\,\sigma_{w_a}^{2})$$

Subsequently, this method was refined to account for current-year survey (\@indivero2023) data and both cohort and year effects. The model for this is: \begin{align}
\hat{w}_{ta} &= \bar w_a e^{\upsilon_t} & a=1, \, t \ge 1964 \\
\hat{w}_{ta} &= \hat{w}_{t-1,a-1} + \Delta_a e^{\psi_t} & a > 1, \, t > 1964 \\
\Delta_a     &= \bar w_{a+1} - \bar w_a & a<A  \\
\bar w_a     &= \alpha \left\{L_1+ \left(L_2-L_1\right)\left(\frac{1-K^{a-1}}{1-K^{A-1}}\right)\right\}^3  \\
\end{align} where the fixed effects parameters are $L_1, L_2, K,$ and $\alpha$ while the random effects parameters are $\upsilon_t$ and $\psi_t$.

and this @afscpro2011

@defilippo2023

# Results

## Alternative error-term specifications

In this section we present the updated error terms associated with the acoustic trawl data (the observations used previously were revised). We also show the impact of using the diagonal covariance matrix and an alternative for the bottom trawl survey data based on the generalized gamma distribution in place of the log-normal. @oleary2022

@cheng2023

@siskey2022

@indivero2023

@bailey2000

In @fig-mod_index_fits_tuned we show how the alternative tuning approaches affected the relative fits and uncertainty assumptions. For the observation-error tuning, the AVO error bars increased slightly while the opposite occurred for the ATS index.

In @fig-sel_ats_tuned we show how the alternative tuning approaches affected the relative fits and uncertainty assumptions. For the observation-error

Updating the ATS data resulted in a different fit to the data trend of those data due to the lower overall uncertainty of the observations specified in revision (@fig-atsalt). This change had a minor impact on the recent estimates of spawning biomass (@fig-atsaltssb).

Changing the bottom-trawl survey error to be based on independent annual survey index values (the base model used a covariance matrix estimated for the series) changed the trend of spawning biomass and uncertainty slightly (@fig-diagssb).

These model estimates for alternative error assumptions indicated that the shows results on goodness of fits while (@tbl-modfitserr) @tbl-modreferr shows the impact of different spawning biomass weights-at-age assumptions.

## Spawning biomass weight-at-age

The random effects model used to estimate weight-at-age for the spawning biomass was based on the A-season fishery, the summer survey data (scaled to have the same mean as the A-season means) shows distinct year and cohort effects (@fig-ssbwt). Compared to the values used in the base model, the trends are very similar but the scales change substantially in some years (@fig-ssbwt ; including the "SSB0" scenario).

@tbl-modfitsssb shows results on goodness of fits while

@tbl-modrefssb shows the impact of different spawning biomass weights-at-age assumptions. Changing the specification of mean body weight-at-age for spawning pollock from status quo had a fairly big impact on the pattern of spawning biomass but among the new alternatives, the difference was minor (@fig-ssbssb).

## Alternative AVO data treatment

@tbl-modfitsavo shows the impact of different AVO data assumptions.

@tbl-modrefavo shows the impact of different AVO data assumptions.

Selectivity at age

# Summary

Based on the results presented, we recommend:

-   Adjustments to the process error term be implemented to provide better consistency between model fitting and input data uncertainty assumptions

-   adopting the revised error structure estimates from the acoustic trawl survey. *these are the best available and reflect a reasonable trade-off*

-   adopting the use of the A-season fishery mean body weight-at-age for the base assessment. *these observations reflect the pattern most available to the spawning season of pollock*

-   adopting the use of the full revised AVO time series. *the data have been recalibrated to the acoustic trawl survey and cover a larger area than previously. This may improve the ability to track expansion and contraction of the pollock stock in mid-water.*

New work improving the approach for estmating cohort and year random effects (@cheng2023) will provide better stuff...

# References

::: {#refs}
:::

{{< pagebreak >}}

# Tables

```{r modfittune}
#| label: tbl-modfitstune
#| tbl-cap: "Goodness-of-fit measures to primary data for different assessment model configurations. RMSE=root-mean square log errors, NLL=negative log-likelihood, SDNR=standard deviation of normalized residuals, Eff. N=effective sample size for composition data)"
#| echo: false
#names(modlst[5:6]) = 
 df <- tab_fit(modtune[c(1:2)])
 df |> gt::gt() |>  gt::fmt_number( rows = c(8:21),decimals=0) 
# tab_style( style = cell_borders( sides = c("bottom"), color = "black", weight = px(1.5), style = "solid" ),
#     locations = cells_body( columns = everything(),
#       rows = c(4,7,10) ) ) 
```

{{< pagebreak >}}

```{r tbl-modreftune}
#| label: tbl-modreftune
#| tbl-cap:  "Summary of model results and the stock condition for EBS pollock. Biomass units are thousands of t."
#| echo: false
df <- NULL
mod_scen <- c(1:2)
for (ii in mod_scen) {
    x       <- modtune[[ii]]
    ssb    <- x$nextyrssbs;         names(ssb)            <- paste0("${B}_{", nextyr ,"}$")
    ssbcv  <- round(x$nextyrssb.cv,2);  names(ssbcv)      <- paste0("$CV_{B_{", nextyr ,"}}$")
    Bmsy   <- x$bmsys;         names(Bmsy)                <- "$B_{MSY}$"
    Bmsycv <- round(x$bmsy.cv,2); names(Bmsycv)           <- "$CV_{B_{MSY}}$"
    spr    <- paste0(round(x$sprmsy*100,0),"\\%");names(spr) <- "SPR rate at $F_{MSY}$"
    b35    <- x$b35s ;                 names(b35)         <- paste0("$B_{35\\%}$")
    pbmsy  <- paste0(round(100*x$ssb1/x$bmsy,0),"\\%");    names(pbmsy)<- paste0("${B}_{", nextyr ,"}/B_{MSY}$")
    bzero  <- x$b0s ;                 names(bzero)        <- paste0("$B_0$")
    dynb0  <- x$dynb0s;      names(dynb0)                 <- paste0("Est. $B_{",thisyr,"} / B_{",thisyr,",no fishing}$")
    b_bmsy <- paste0(round(x$curssb/x$bmsy*100,0),"\\%");      names(b_bmsy) <- paste0("$B_{",thisyr,"} / B_{MSY}$")
    steep  <- round(x$steep,2);               names(steep) <- "Steepness"
    v      <- c(ssb, ssbcv, Bmsy, Bmsycv, pbmsy, bzero,b35, spr ,steep, dynb0,b_bmsy)
    df     <- cbind(df, v)
 }
df <- data.frame(rownames(df), df, row.names = NULL)
names(df) <- c("Component",mod_tune_names[mod_scen])
df |> gt::gt() |> gt::fmt_markdown()
```

{{< pagebreak >}}

```{r modfitsavo}
#| label: tbl-modfitsavo
#| tbl-cap: "Goodness-of-fit measures to primary data for different assessment model configurations. RMSE=root-mean square log errors, NLL=negative log-likelihood, SDNR=standard deviation of normalized residuals, Eff. N=effective sample size for composition data)"
#| echo: false
#names(modlst[5:6]) = 
df <- tab_fit(modlst[c(2:4)])
df |> gt::gt() |>  gt::fmt_number( rows = c(8:21),decimals=0)
```

{{< pagebreak >}}

```{r modfitserr}
#| label: tbl-modfitserr
#| tbl-cap: "Goodness-of-fit measures to primary data for different assessment model configurations. RMSE=root-mean square log errors, NLL=negative log-likelihood, SDNR=standard deviation of normalized residuals, Eff. N=effective sample size for composition data)"
#| echo: false
df <- tab_fit(modlst[c(5:8)])
df |> gt::gt() |>  gt::fmt_number( rows = c(8:21),decimals=0) 
# |>  tab_style( style = cell_borders( sides = c("bottom"), color = "black", weight = px(1.5), style = "solid" ),
    # locations = cells_body( columns = everything(),
      # rows = c(4,7,10) ) ) 
```

{{< pagebreak >}}

```{r tbl-modreferr}
#| label: tbl-modreferr
#| tbl-cap:  "Summary of model results and the stock condition for EBS pollock. Biomass units are thousands of t."
#| echo: false
df <- NULL
mod_scen <- c(5:8)
for (ii in mod_scen) {
    x       <- modlst[[ii]]
    ssb    <- x$nextyrssbs;         names(ssb)            <- paste0("${B}_{", nextyr ,"}$")
    ssbcv  <- round(x$nextyrssb.cv,2);  names(ssbcv)      <- paste0("$CV_{B_{", nextyr ,"}}$")
    Bmsy   <- x$bmsys;         names(Bmsy)                <- "$B_{MSY}$"
    Bmsycv <- round(x$bmsy.cv,2); names(Bmsycv)           <- "$CV_{B_{MSY}}$"
    spr    <- paste0(round(x$sprmsy*100,0),"\\%");names(spr) <- "SPR rate at $F_{MSY}$"
    b35    <- x$b35s ;                 names(b35)         <- paste0("$B_{35\\%}$")
    pbmsy  <- paste0(round(100*x$ssb1/x$bmsy,0),"\\%");    names(pbmsy)<- paste0("${B}_{", nextyr ,"}/B_{MSY}$")
    bzero  <- x$b0s ;                 names(bzero)        <- paste0("$B_0$")
    dynb0  <- x$dynb0s;      names(dynb0)                 <- paste0("Est. $B_{",thisyr,"} / B_{",thisyr,",no fishing}$")
    b_bmsy <- paste0(round(x$curssb/x$bmsy*100,0),"\\%");      names(b_bmsy) <- paste0("$B_{",thisyr,"} / B_{MSY}$")
    steep  <- round(x$steep,2);               names(steep) <- "Steepness"
    v      <- c(ssb, ssbcv, Bmsy, Bmsycv, pbmsy, bzero,b35, spr ,steep, dynb0,b_bmsy)
    df     <- cbind(df, v)
 }
df <- data.frame(rownames(df), df, row.names = NULL)
names(df) <- c("Component",mod_names[mod_scen])
df |> gt::gt() |> gt::fmt_markdown()
```

{{< pagebreak >}}

```{r modfitsssb}
#| label: tbl-modfitsssb
#| tbl-cap: "Goodness-of-fit measures to primary data for different assessment model configurations. RMSE=root-mean square log errors, NLL=negative log-likelihood, SDNR=standard deviation of normalized residuals, Eff. N=effective sample size for composition data)"
#| echo: false
#names(modlst[5:6]) = 
df <- tab_fit(modlst[c(4,9:11)])
df |> gt::gt() |>  gt::fmt_number( rows = c(8:21),decimals=0)
```

{{< pagebreak >}}

```{r tbl-modrefssb}
#| label: tbl-modrefssb
#| tbl-cap:  "Summary of model results and the stock condition for EBS pollock. Biomass units are thousands of t."
#| echo: false
df <- NULL
mod_scen <- c(4,9:11)
for (ii in mod_scen) {
    x       <- modlst[[ii]]
    ssb    <- x$nextyrssbs;         names(ssb)            <- paste0("${B}_{", nextyr ,"}$")
    ssbcv  <- round(x$nextyrssb.cv,2);  names(ssbcv)      <- paste0("$CV_{B_{", nextyr ,"}}$")
    Bmsy   <- x$bmsys;         names(Bmsy)                <- "$B_{MSY}$"
    Bmsycv <- round(x$bmsy.cv,2); names(Bmsycv)           <- "$CV_{B_{MSY}}$"
    spr    <- paste0(round(x$sprmsy*100,0),"\\%");names(spr) <- "SPR rate at $F_{MSY}$"
    b35    <- x$b35s ;                 names(b35)         <- paste0("$B_{35\\%}$")
    pbmsy  <- paste0(round(100*x$ssb1/x$bmsy,0),"\\%");    names(pbmsy)<- paste0("${B}_{", nextyr ,"}/B_{MSY}$")
    bzero  <- x$b0s ;                 names(bzero)        <- paste0("$B_0$")
    dynb0  <- x$dynb0s;      names(dynb0)                 <- paste0("Est. $B_{",thisyr,"} / B_{",thisyr,",no fishing}$")
    b_bmsy <- paste0(round(x$curssb/x$bmsy*100,0),"\\%");      names(b_bmsy) <- paste0("$B_{",thisyr,"} / B_{MSY}$")
    steep  <- round(x$steep,2);               names(steep) <- "Steepness"
    v      <- c(ssb, ssbcv, Bmsy, Bmsycv, pbmsy, bzero,b35, spr ,steep, dynb0,b_bmsy)
    df     <- cbind(df, v)
 }
df <- data.frame(rownames(df), df, row.names = NULL)
names(df) <- c("Component",mod_names[mod_scen])
df |> gt::gt() |> gt::fmt_markdown()
```

{{< pagebreak >}}

```{r tbl-modrefavo}
#| label: tbl-modrefavo
#| tbl-cap:  "Summary of model results and the stock condition for EBS pollock. Biomass units are thousands of t."
#| echo: false
df <- NULL
mod_scen <- c(2:4)
for (ii in mod_scen) {
    x       <- modlst[[ii]]
    ssb    <- x$nextyrssbs;         names(ssb)            <- paste0("${B}_{", nextyr ,"}$")
    ssbcv  <- round(x$nextyrssb.cv,2);  names(ssbcv)      <- paste0("$CV_{B_{", nextyr ,"}}$")
    Bmsy   <- x$bmsys;         names(Bmsy)                <- "$B_{MSY}$"
    Bmsycv <- round(x$bmsy.cv,2); names(Bmsycv)           <- "$CV_{B_{MSY}}$"
    spr    <- paste0(round(x$sprmsy*100,0),"\\%");names(spr) <- "SPR rate at $F_{MSY}$"
    b35    <- x$b35s ;                 names(b35)         <- paste0("$B_{35\\%}$")
    pbmsy  <- paste0(round(100*x$ssb1/x$bmsy,0),"\\%");    names(pbmsy)<- paste0("${B}_{", nextyr ,"}/B_{MSY}$")
    bzero  <- x$b0s ;                 names(bzero)        <- paste0("$B_0$")
    dynb0  <- x$dynb0s;      names(dynb0)                 <- paste0("Est. $B_{",thisyr,"} / B_{",thisyr,",no fishing}$")
    b_bmsy <- paste0(round(x$curssb/x$bmsy*100,0),"\\%");      names(b_bmsy) <- paste0("$B_{",thisyr,"} / B_{MSY}$")
    steep  <- round(x$steep,2);               names(steep) <- "Steepness"
    v      <- c(ssb, ssbcv, Bmsy, Bmsycv, pbmsy, bzero,b35, spr ,steep, dynb0,b_bmsy)
    df     <- cbind(df, v)
 }
df <- data.frame(rownames(df), df, row.names = NULL)
names(df) <- c("Component",mod_names[mod_scen])
df |> gt::gt() |> gt::fmt_markdown()
```

{{< pagebreak >}}

# Figures

![Fit of EBS pollock model to acoustic trawl survey data from the 2022 error-term specification (top) and that of the revised errors (bottom).](doc/figs/mod_ats_updated.pdf){#fig-atsalt}

`r cap1='Results of the EBS pollock model for recent spawning biomass estimates showing the impact of the revised acoustic trawl survey data error estimates (updated ATS is considered the base model from 2022).'`

![\`Results of the EBS pollock model for recent spawning biomass estimates showing the impact of the revised acoustic trawl survey data error estimates (updated ATS is considered the base model from 2022).](doc/figs/mod_ats_updated_ssb.pdf){#fig-atsaltssb}

![Results of the EBS pollock model for recent spawning biomass estimates comparing the base model using the covariance matrix with the one where only the diagonal is applied.](doc/figs/mod_diag_ssb.pdf){#fig-diagssb}

![Weight-at-age data (left and middle panel) and predictions (right-most panel) for EBS pollock as an alternative series for spawning biomass weight-at-age. Note that the color shadings indicate the anomaly within age (columns).](doc/figs/ssb_wtage_data_pred.pdf){#fig-ssbwt}

![Alternative scenarios for body weight-at-age used for computing spawning biomass for EBS pollock biomass weight-at-age.](doc/figs/wt_ssb.pdf){#fig-wt_ssb}

![Results of the EBS pollock model for recent spawning biomass estimates comparing the base model under different assumptions about mean body weight-at-age during spawning.](doc/figs/mod_ssb_ssb.pdf){#fig-ssbssb}

![Time varying acoustic trawl selectivity estimates for the process-error tuned model.](doc/figs/sel_ats_tuned.pdf){#fig-sel_ats_tuned}

![Time series of EBS pollock data from the acoustic vessels of opportunity (AVO) showing the years of new data compared to previous series and the full series.](doc/figs/AVO_Series_change.png){#fig-avodata}

![Comparison of the model fit to acoustic trawl survey (top) and tacoustic vessels of opportunity (AVO; bottom) for the 2022 assessment and tuning process error terms or observation errors.](doc/figs/mod_index_fits_tuned.pdf){#fig-mod_index_fits_tuned}

![One-step ahead residual plots, see @trijoulet2023 for details.](doc/figs/EBSpollock_tuned_ats_age.pdf){#fig-OSAats}

::: callout-warning
Here is a warning.
:::

::: callout-note
shit Note that there are five types of callouts, including: `note`, `tip`, `warning`, `caution`, and `important`.
:::

::: callout-important
Note that there are five types of callouts, including: `note`, `tip`, `warning`, `caution`, and `important`.
:::
